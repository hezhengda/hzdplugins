

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>hzdplugins.aiida.submit &mdash; hzdplugins 0.0.11 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/my_theme.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> hzdplugins
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../hzdplugins.html">hzdplugins Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../log.html">This is the log file for hzdplugins</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">hzdplugins</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>hzdplugins.aiida.submit</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for hzdplugins.aiida.submit</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">StructureData</span><span class="p">,</span> <span class="n">KpointsData</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<div class="viewcode-block" id="qePwOriginalSubmit"><a class="viewcode-back" href="../../../hzdplugins.html#hzdplugins.aiida.submit.qePwOriginalSubmit">[docs]</a><span class="k">def</span> <span class="nf">qePwOriginalSubmit</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">codename</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">add_parameters</span><span class="p">,</span> <span class="n">del_parameters</span><span class="p">,</span> <span class="n">kpoints</span><span class="p">,</span> <span class="n">pseudo_family</span><span class="p">,</span> <span class="n">cluster_options</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    `qePwOriginalSubmit` will submit an original computational task to the desired computer by using certain code.</span>

<span class="sd">    Parameters:</span>

<span class="sd">    results:</span>
<span class="sd">        A dictionary that has all the relevant information about the</span>

<span class="sd">    codename:</span>
<span class="sd">        A string. Represent the code for pw.x that you want to use</span>

<span class="sd">    structure:</span>
<span class="sd">        A StructureData object. The structure of your system. It needs to be StructureData type.</span>

<span class="sd">    add_parameters:</span>
<span class="sd">        A dictionary. The desired parameters that you want to state, it can be incomplete, because inside the function there is a default setting for parameters which can be used in most cases, but if you have specific need, you can put that in parameters, the format is similar as pw.x input file.</span>

<span class="sd">        If you want to assign DFT+U and spin-polarization, you need to specify it on your own.</span>

<span class="sd">        e.g. {&#39;CONTROL&#39;:{}, &#39;SYSTEM&#39;:{}}</span>

<span class="sd">    del_parameters:</span>
<span class="sd">        A dictionary. The tags that we would like to delete, for example if we do not want to use spin-polarized simulation, then &#39;nspin&#39; needs to be deleted. Same structure as add_parameters.</span>

<span class="sd">        e.g. {&#39;CONTROL&#39;: [key1, key2, key3], &#39;SYSTEM&#39;: [key1, key2, key3]}</span>

<span class="sd">    kpoints:</span>
<span class="sd">        A list of lists. The kpoints that you want to use, if the kpoints has only 1 list, then it is the kpoint mesh, but if two lists are detected, then the first will be k-point mesh, the second one will be the origin of k-point mesh.e.g. [[3, 3, 1]] or [[3, 3, 1],[0.5, 0.5, 0.5]]</span>

<span class="sd">    pseudo_family:</span>
<span class="sd">        A string. The pseudopotential family that you want to use. Make sure that you already have that configured, otherwise an error will occur.</span>

<span class="sd">    cluster_options:</span>
<span class="sd">        A dictionary. The detailed option for the cluster. Different cluster may have different settings. There are some keywords are necessary: (1) resources (2) max_wallclock_seconds (3) account (4) queue_name</span>

<span class="sd">    metadata:</span>
<span class="sd">        A dictionary. The dictionary that contains information about metadata. For example: label and description. label and description are mendatory.</span>

<span class="sd">    Return:</span>
<span class="sd">        results: a modified results dictionary with the latest submitted job</span>
<span class="sd">        pk: the id of that CalcJob</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">results_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="c1"># first we need to create a copy for our simulation</span>

    <span class="n">code</span> <span class="o">=</span> <span class="n">Code</span><span class="o">.</span><span class="n">get_from_string</span><span class="p">(</span><span class="n">codename</span><span class="p">)</span>
    <span class="n">pw_builder</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">get_builder</span><span class="p">()</span>

    <span class="c1"># pseudopotential</span>
    <span class="n">pw_builder</span><span class="o">.</span><span class="n">pseudos</span> <span class="o">=</span> <span class="n">get_pseudos_from_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">family_name</span><span class="o">=</span><span class="n">pseudo_family</span><span class="p">)</span>

    <span class="c1"># set kpoints</span>
    <span class="n">kpts</span> <span class="o">=</span> <span class="n">KpointsData</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpoints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">kpts</span><span class="o">.</span><span class="n">set_kpoints_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">kpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kpts</span><span class="o">.</span><span class="n">set_kpoints_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">kpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">offset</span><span class="o">=</span><span class="n">kpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># parameters</span>
    <span class="n">parameters_default</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;CONTROL&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;calculation&#39;</span><span class="p">:</span> <span class="s1">&#39;vc-relax&#39;</span><span class="p">,</span>
            <span class="s1">&#39;max_seconds&#39;</span><span class="p">:</span> <span class="mi">86000</span><span class="p">,</span>
            <span class="s1">&#39;restart_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;from_scratch&#39;</span><span class="p">,</span>
            <span class="s1">&#39;wf_collect&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;nstep&#39;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
            <span class="s1">&#39;tstress&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;tprnfor&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;etot_conv_thr&#39;</span><span class="p">:</span> <span class="mf">1e-06</span><span class="p">,</span>
            <span class="s1">&#39;forc_conv_thr&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
            <span class="s1">&#39;disk_io&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
            <span class="s1">&#39;verbosity&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;SYSTEM&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;ibrav&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;nosym&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;ecutwfc&#39;</span><span class="p">:</span> <span class="mf">80.0</span><span class="p">,</span>
            <span class="s1">&#39;ecutrho&#39;</span><span class="p">:</span> <span class="mf">640.0</span><span class="p">,</span>
            <span class="s1">&#39;occupations&#39;</span><span class="p">:</span> <span class="s1">&#39;smearing&#39;</span><span class="p">,</span>
            <span class="s1">&#39;degauss&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span>
            <span class="s1">&#39;smearing&#39;</span><span class="p">:</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
            <span class="s1">&#39;input_dft&#39;</span><span class="p">:</span> <span class="s1">&#39;PBE&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;ELECTRONS&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;electron_maxstep&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s1">&#39;conv_thr&#39;</span><span class="p">:</span> <span class="mf">1.0e-6</span><span class="p">,</span>
            <span class="s1">&#39;diagonalization&#39;</span><span class="p">:</span> <span class="s1">&#39;david&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mixing_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;local-TF&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mixing_beta&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="s1">&#39;mixing_ndim&#39;</span><span class="p">:</span> <span class="mi">10</span>
        <span class="p">}</span>
    <span class="p">})</span>

    <span class="c1"># add parameters in add_parameters</span>
    <span class="n">parameters_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">parameters_default</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">add_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">key2</span><span class="p">,</span> <span class="n">value2</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parameters_tmp</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">key2</span><span class="p">]</span> <span class="o">=</span> <span class="n">value2</span>

    <span class="c1"># delete parameters in del_parameters</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">del_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">parameters_tmp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key2</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key2</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">parameters_default</span> <span class="o">=</span> <span class="n">parameters_tmp</span>

    <span class="c1"># set labels and description</span>
    <span class="n">pw_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
    <span class="n">pw_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>

    <span class="c1"># set options for slurm</span>
    <span class="n">pw_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">cluster_options</span><span class="p">[</span><span class="s1">&#39;resources&#39;</span><span class="p">]</span> <span class="c1"># in here machine = node</span>
    <span class="n">pw_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">max_wallclock_seconds</span> <span class="o">=</span> <span class="n">cluster_options</span><span class="p">[</span><span class="s1">&#39;max_wallclock_seconds&#39;</span><span class="p">]</span> <span class="c1"># in here machine = node</span>
    <span class="n">pw_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">cluster_options</span><span class="p">[</span><span class="s1">&#39;account&#39;</span><span class="p">]</span> <span class="c1"># in here machine = node</span>
    <span class="n">pw_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">scheduler_stderr</span> <span class="o">=</span> <span class="s1">&#39;stderr&#39;</span>
    <span class="n">pw_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">scheduler_stdout</span> <span class="o">=</span> <span class="s1">&#39;stdout&#39;</span>
    <span class="k">if</span> <span class="n">cluster_options</span><span class="p">[</span><span class="s1">&#39;queue_name&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pw_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">queue_name</span> <span class="o">=</span> <span class="n">cluster_options</span><span class="p">[</span><span class="s1">&#39;queue_name&#39;</span><span class="p">]</span>

    <span class="c1"># launch the simulation</span>
    <span class="n">pw_builder</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
    <span class="n">pw_builder</span><span class="o">.</span><span class="n">kpoints</span> <span class="o">=</span> <span class="n">kpts</span>
    <span class="n">pw_builder</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters_default</span>
    <span class="n">pw_builder</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;CMDLINE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;-npools&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">]})</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">submit</span><span class="p">(</span><span class="n">pw_builder</span><span class="p">)</span>

    <span class="c1"># results</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;original&#39;</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;system&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;comp_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters_default</span><span class="p">[</span><span class="s1">&#39;CONTROL&#39;</span><span class="p">][</span><span class="s1">&#39;calculation&#39;</span><span class="p">]</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;remove_remote_folder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;E / eV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;xc functional&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters_default</span><span class="p">[</span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">][</span><span class="s1">&#39;input_dft&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">results_tmp</span><span class="p">,</span> <span class="n">calc</span><span class="o">.</span><span class="n">pk</span></div>

<div class="viewcode-block" id="qePwContinueSubmit"><a class="viewcode-back" href="../../../hzdplugins.html#hzdplugins.aiida.submit.qePwContinueSubmit">[docs]</a><span class="k">def</span> <span class="nf">qePwContinueSubmit</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">add_parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">del_parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">kpoints</span><span class="o">=</span><span class="p">[],</span> <span class="n">pseudo_family</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cluster_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{}):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    `qePwContinueSubmit` will continue a simulation with similar or modified input parameters. All the parameters are listed in the kwargs</span>

<span class="sd">    Parameters:</span>

<span class="sd">    pk:</span>
<span class="sd">        The id of previous calculation. We will start our calculation from there.</span>

<span class="sd">    add_parameters:</span>
<span class="sd">        A dictionary. The desired parameters that you want to state, it can be incomplete, because inside the function there is a default setting for parameters which can be used in most cases, but if you have specific need, you can put that in parameters, the format is similar as pw.x input file.</span>

<span class="sd">        If you want to assign DFT+U and spin-polarization, you need to specify it on your own.</span>

<span class="sd">        e.g. {&#39;CONTROL&#39;:{}, &#39;SYSTEM&#39;:{}}</span>

<span class="sd">    del_parameters:</span>
<span class="sd">        A dictionary. The tags that we would like to delete, for example if we do not want to use spin-polarized simulation, then &#39;nspin&#39; needs to be deleted. Same structure as add_parameters.</span>

<span class="sd">        e.g. {&#39;CONTROL&#39;: [key1, key2, key3], &#39;SYSTEM&#39;: [key1, key2, key3]}</span>

<span class="sd">    kpoints:</span>
<span class="sd">        A list of lists. The kpoints that you want to use, if the kpoints has only 1 list, then it is the kpoint mesh, but if two lists are detected, then the first will be k-point mesh, the second one will be the origin of k-point mesh.e.g. [[3, 3, 1]] or [[3, 3, 1],[0.5, 0.5, 0.5]]</span>

<span class="sd">    pseudo_family:</span>
<span class="sd">        A string. The pseudopotential family that you want to use. Make sure that you already have that configured, otherwise an error will occur.</span>

<span class="sd">    cluster_options:</span>
<span class="sd">        A dictionary. The detailed option for the cluster. Different cluster may have different settings. There are some keywords are necessary: (1) resources (2) max_wallclock_seconds (3) account (4) queue_name</span>

<span class="sd">    metadata:</span>
<span class="sd">        A dictionary. The dictionary that contains information about metadata. For example: label and description. label and description are mendatory.</span>

<span class="sd">    Return:</span>
<span class="sd">        results: a modified results dictionary with the latest submitted job</span>
<span class="sd">        pk: the id of that CalcJob</span>

<span class="sd">    Return:</span>
<span class="sd">        results: a modified results dictionary with the latest submitted job</span>
<span class="sd">        pk: the id of that CalcJob</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">results_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">load_node</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>

    <span class="n">restart_builder</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_builder_restart</span><span class="p">()</span> <span class="c1"># get the restart_builder</span>

    <span class="n">parameters_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">output_structure</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">add_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">key2</span><span class="p">,</span> <span class="n">value2</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parameters_tmp</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">key2</span><span class="p">]</span> <span class="o">=</span> <span class="n">value2</span>

    <span class="c1"># delete parameters in del_parameters</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">del_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">parameters_tmp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key2</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key2</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">parameters_default</span> <span class="o">=</span> <span class="n">parameters_tmp</span>

    <span class="c1"># reset the kpoints</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpoints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">kpts</span> <span class="o">=</span> <span class="n">KpointsData</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpoints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">kpts</span><span class="o">.</span><span class="n">set_kpoints_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">kpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kpts</span><span class="o">.</span><span class="n">set_kpoints_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">kpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">offset</span><span class="o">=</span><span class="n">kpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kpts</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">kpoints</span>

    <span class="c1"># reset the pseudo_family</span>
    <span class="k">if</span> <span class="n">pseudo_family</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">restart_builder</span><span class="o">.</span><span class="n">pseudos</span> <span class="o">=</span> <span class="n">get_pseudos_from_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">family_name</span><span class="o">=</span><span class="n">pseudo_family</span><span class="p">)</span>

    <span class="c1"># reset cluster_options:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_options</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;resources&#39;</span> <span class="ow">in</span> <span class="n">cluster_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">restart_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">cluster_options</span><span class="p">[</span><span class="s1">&#39;resources&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;max_wallclock_seconds&#39;</span> <span class="ow">in</span> <span class="n">cluster_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">restart_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">max_wallclock_seconds</span> <span class="o">=</span> <span class="n">cluster_options</span><span class="p">[</span><span class="s1">&#39;max_wallclock_seconds&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;account&#39;</span> <span class="ow">in</span> <span class="n">cluster_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">restart_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">cluster_options</span><span class="p">[</span><span class="s1">&#39;account&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;queue_name&#39;</span> <span class="ow">in</span> <span class="n">cluster_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">restart_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">queue_name</span> <span class="o">=</span> <span class="n">cluster_options</span><span class="p">[</span><span class="s1">&#39;queue_name&#39;</span><span class="p">]</span>

    <span class="c1"># reset metadata</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">restart_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">restart_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">label</span>

        <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">restart_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">restart_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">description</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">restart_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">label</span>
        <span class="n">restart_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">description</span>

    <span class="c1"># submit the calculation</span>
    <span class="n">restart_builder</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
    <span class="n">restart_builder</span><span class="o">.</span><span class="n">kpoints</span> <span class="o">=</span> <span class="n">kpts</span>
    <span class="n">restart_builder</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters_default</span>
    <span class="n">restart_builder</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;CMDLINE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;-npools&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">]})</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">submit</span><span class="p">(</span><span class="n">restart_builder</span><span class="p">)</span>

    <span class="c1"># results</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;continue from &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;system&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">restart_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">label</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">restart_builder</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">description</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;comp_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters_default</span><span class="p">[</span><span class="s1">&#39;CONTROL&#39;</span><span class="p">][</span><span class="s1">&#39;calculation&#39;</span><span class="p">]</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;remove_remote_folder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;E / eV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">results_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">)][</span><span class="s1">&#39;xc functional&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters_default</span><span class="p">[</span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">][</span><span class="s1">&#39;input_dft&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">results_tmp</span><span class="p">,</span> <span class="n">calc</span><span class="o">.</span><span class="n">pk</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Zheng-Da He

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>